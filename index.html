<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‰‹æ–é‡ç—‡è¨˜éŒ„ 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-neutral-950 text-white select-none">

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[200] bg-yellow-400 text-black px-6 py-3 rounded-full font-black shadow-2xl border-2 border-black opacity-0 transition-all duration-300 pointer-events-none whitespace-nowrap"></div>

    <!-- å…‹åˆ¶è­¦å‘Šå½ˆçª— -->
    <div id="warning-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[150] hidden items-center justify-center p-6">
        <div class="bg-red-600 text-white p-8 rounded-[2.5rem] border-4 border-white shadow-[0_0_50px_rgba(220,38,38,0.5)] max-w-sm w-full text-center">
            <div class="bg-white text-red-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-exclamation-triangle text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black mb-4">æª¢æ¸¬åˆ°éé‡æ”å–ï¼</h2>
            <p class="text-lg font-bold mb-8 opacity-90">ä½ ä»Šå¤©å–å¤ªå¤šäº†ï¼Œçµ¦æˆ‘å…‹åˆ¶ä¸€é»ï¼</p>
            <button onclick="confirmSave()" class="w-full bg-white text-red-600 font-black py-4 rounded-2xl active:scale-95 shadow-lg mb-4">æˆ‘çŸ¥é“äº†ï¼Œé€™æ˜¯æœ€å¾Œä¸€æ¯</button>
            <button onclick="closeWarning()" class="text-sm font-bold opacity-60 underline">å…ˆä¸è¦å­˜äº†</button>
        </div>
    </div>

    <div class="max-w-xl mx-auto p-4 pb-20">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 bg-yellow-400 px-6 py-4 rounded-3xl shadow-lg border-b-8 border-black gap-2">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-black text-black whitespace-nowrap">æ‰‹æ–é‡ç—‡æ‚£è€…è¨˜éŒ„è¡¨ <span class="text-2xl">ğŸ¥¤</span></h1>
                <div class="h-4 w-px bg-black/20 hidden sm:block"></div>
                <p class="text-black/70 font-bold text-xs italic">åŠ å¼·ç‰ˆè³‡æ–™ç·©å­˜ç³»çµ±</p>
            </div>
            <div class="flex items-center gap-3 text-black">
                <span class="text-[10px] font-black bg-black/10 px-2 py-1 rounded-md tracking-wider">INDEXED-DB VER.</span>
            </div>
        </header>

        <!-- æ•¸æ“šçµ±è¨ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="stats-area">
            <div class="bg-neutral-900 p-5 rounded-3xl border-2 border-neutral-800 shadow-inner">
                <div class="flex items-center gap-2 text-yellow-400 mb-4 font-bold text-sm tracking-wider uppercase">
                    <i class="fas fa-award"></i> å¹´åº¦æ’è¡Œå† è»
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
                        <p class="text-[10px] text-neutral-500 mb-1">æœ€å¸¸å…‰é¡§åº—å®¶</p>
                        <p id="stat-top-shop" class="text-sm font-black text-white truncate">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
                        <p class="text-[10px] text-neutral-500 mb-1">æœ€æ„›é£²å“å“é …</p>
                        <p id="stat-top-item" class="text-sm font-black text-white truncate">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
            <div class="bg-neutral-900 p-5 rounded-3xl border-2 border-neutral-800 shadow-inner">
                <div class="flex items-center gap-2 text-yellow-400 mb-4 font-bold text-sm tracking-wider uppercase">
                    <i class="fas fa-dollar-sign"></i> çµ±è¨ˆæ•¸æ“š
                </div>
                <div class="grid grid-cols-4 gap-2 text-[9px]">
                    <div class="bg-neutral-800 p-2 rounded-2xl border border-neutral-700 text-center">
                        <p class="text-neutral-500 mb-1">ç•¶æœˆæ¬¡æ•¸</p>
                        <p id="stat-month-count" class="text-base font-black text-yellow-400">0</p>
                    </div>
                    <div class="bg-neutral-800 p-2 rounded-2xl border border-neutral-700 text-center">
                        <p class="text-neutral-500 mb-1">ç•¶æœˆæ”¯å‡º</p>
                        <p id="stat-month-total" class="text-base font-black text-yellow-400">$0</p>
                    </div>
                    <div class="bg-neutral-800 p-2 rounded-2xl border border-neutral-700 text-center">
                        <p class="text-neutral-500 mb-1">å¹´åº¦æ¬¡æ•¸</p>
                        <p id="stat-year-count" class="text-base font-black text-white">0</p>
                    </div>
                    <div class="bg-neutral-800 p-2 rounded-2xl border border-neutral-700 text-center">
                        <p class="text-neutral-500 mb-1">å¹´åº¦ç¸½é¡</p>
                        <p id="stat-year-total" class="text-base font-black text-white">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥æ›† -->
        <div class="bg-neutral-900 rounded-[2rem] p-6 mb-6 shadow-2xl border border-neutral-800">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="p-2 bg-neutral-800 rounded-xl border border-neutral-700 active:scale-90"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-title" class="text-lg font-black text-yellow-400 min-w-[60px] text-center">1æœˆ</h2>
                    <button onclick="changeMonth(1)" class="p-2 bg-neutral-800 rounded-xl border border-neutral-700 active:scale-90"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="text-right border-l border-neutral-700 pl-4 font-black">
                    <p class="text-[9px] text-neutral-500 uppercase">MONTHLY TOTAL</p>
                    <p id="month-total-small" class="text-sm text-yellow-400">$0</p>
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-3"></div>
        </div>
    </div>

    <!-- å½ˆçª— -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4 z-50 hidden">
        <div class="bg-neutral-900 w-full max-w-xl rounded-t-[2.5rem] sm:rounded-[2.5rem] border-x-4 border-t-4 sm:border-b-4 border-yellow-400 overflow-hidden flex flex-col max-h-[92vh]">
            <div class="p-5 bg-yellow-400 flex justify-between items-center text-black">
                <div class="flex items-center gap-3">
                    <div id="modal-date-badge" class="bg-black text-yellow-400 px-3 py-1 rounded-xl font-black text-sm">1æœˆ 1æ—¥</div>
                    <h2 class="text-lg font-black uppercase tracking-widest">Recipe</h2>
                </div>
                <button onclick="closeModal()" class="bg-black text-white p-2 rounded-xl active:scale-90"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 no-scrollbar safe-bottom">
                <div id="daily-list-container" class="space-y-2"></div>
                <div class="bg-neutral-800/50 p-6 rounded-3xl space-y-5 border border-neutral-700">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="f-name" class="bg-neutral-900 border-2 border-neutral-700 rounded-2xl p-3 text-sm text-white focus:border-yellow-400 outline-none font-bold" placeholder="é£²å“åç¨±">
                        <input id="f-shop" class="bg-neutral-900 border-2 border-neutral-700 rounded-2xl p-3 text-sm text-white focus:border-yellow-400 outline-none font-bold" placeholder="åº—å®¶">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="f-price" type="number" class="bg-neutral-900 border-2 border-neutral-700 rounded-2xl p-3 text-sm text-white focus:border-yellow-400 outline-none font-bold" placeholder="åƒ¹æ ¼">
                        <select id="f-type" class="bg-neutral-900 border-2 border-neutral-700 rounded-2xl p-3 text-sm text-white focus:border-yellow-400 outline-none font-bold appearance-none">
                            <option>ç´”èŒ¶é¡</option><option>æœèŒ¶é¡</option><option>ç‰¹èª¿é¡</option><option>å¥¶èŒ¶é¡</option><option>å’€åš¼é¡</option><option>å†¬ç“œé¡</option><option>å¥¶è“‹é¡</option><option>å’–å•¡</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] text-yellow-400 font-black uppercase ml-1">ç”œåº¦</p>
                        <div id="sugar-group" class="grid grid-cols-3 sm:grid-cols-6 gap-2"></div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] text-yellow-400 font-black uppercase ml-1">å†°å¡Š</p>
                        <div id="ice-group" class="grid grid-cols-3 sm:grid-cols-7 gap-1"></div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] text-yellow-400 font-black uppercase ml-1">è©•åƒ¹</p>
                        <div id="rating-group" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                    </div>
                    <button onclick="handleSave()" class="w-full bg-yellow-400 text-black font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95">
                        <i class="fas fa-save"></i> ç¢ºå®šå­˜å…¥è—¥å–® ğŸ’Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IndexedDB æ ¸å¿ƒé‚è¼¯ ---
        let db;
        const DB_NAME = "DrinkTrackerDB";
        const STORE_NAME = "records";

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve();
                };
                request.onerror = (e) => reject("DB Open Error");
            });
        }

        async function getAllRecords() {
            return new Promise((resolve) => {
                const transaction = db.transaction(STORE_NAME, "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function saveRecordToDB(record) {
            return new Promise((resolve) => {
                const transaction = db.transaction(STORE_NAME, "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                store.put(record);
                transaction.oncomplete = () => resolve();
            });
        }

        async function deleteRecordFromDB(id) {
            return new Promise((resolve) => {
                const transaction = db.transaction(STORE_NAME, "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                store.delete(id);
                transaction.oncomplete = () => resolve();
            });
        }

        // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        let records = [];
        let currentMonth = new Date().getMonth();
        let currentYear = 2026;
        let selectedDateStr = "";
        let selectedSugar = "å¾®ç³–", selectedIce = "å»å†°", selectedRating = "äº”æ˜Ÿ";

        const sugarOptions = ['ç„¡ç³–', 'ä¸€åˆ†ç³–', 'å¾®ç³–', 'å°‘ç³–', 'åŠç³–', 'å›ºå®šç³–'];
        const iceOptions = ['æº«', 'ç†±', 'å»å†°', 'å¾®å†°', 'å°‘å†°', 'æ­£å¸¸å†°', 'å†°å›ºå®š'];
        const ratingOptions = [
            { label: 'ä¸€é¡†æ˜Ÿéƒ½å¤šæ–¼', value: '0æ˜Ÿ', display: 'ğŸ’€' },
            { label: 'ä¸€æ˜Ÿ', value: 'ä¸€æ˜Ÿ', display: 'â­' },
            { label: 'äºŒæ˜Ÿ', value: 'äºŒæ˜Ÿ', display: 'â­â­' },
            { label: 'ä¸‰æ˜Ÿ', value: 'ä¸‰æ˜Ÿ', display: 'â­â­â­' },
            { label: 'å››æ˜Ÿ', value: 'å››æ˜Ÿ', display: 'â­â­â­â­' },
            { label: 'äº”æ˜Ÿ', value: 'äº”æ˜Ÿ', display: 'â­â­â­â­â­' }
        ];

        window.onload = async () => {
            await initDB();
            records = await getAllRecords();
            initOptionUI();
            updateStats();
            renderCalendar();
            
            // é‡è¦ï¼šå³ä½¿ä½¿ç”¨ IndexedDBï¼Œä¾èˆŠç¶­æŒ visibility ç›£æ§
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'hidden') {
                    // IndexedDB åœ¨å¯«å…¥æ™‚å·²ç¶“æ˜¯åŒæ­¥ç£ç¢Ÿï¼Œé€™è£¡åšé¡å¤–ç¢ºèª
                    records = await getAllRecords();
                    updateStats();
                }
            });
        };

        function initOptionUI() {
            const sg = document.getElementById('sugar-group');
            sugarOptions.forEach(opt => sg.appendChild(createBtn(opt, 'sugar-btn', () => { selectedSugar = opt; refreshBtns('sugar-btn', opt); }, selectedSugar === opt)));
            
            const ig = document.getElementById('ice-group');
            iceOptions.forEach(opt => ig.appendChild(createBtn(opt, 'ice-btn', () => { selectedIce = opt; refreshBtns('ice-btn', opt); }, selectedIce === opt)));

            const rg = document.getElementById('rating-group');
            ratingOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `rating-btn flex flex-col items-center justify-center p-2 rounded-2xl text-[10px] font-black border-2 transition-all ${selectedRating === opt.value ? 'bg-yellow-400 text-black border-yellow-400' : 'bg-neutral-900 text-neutral-400 border-neutral-700'}`;
                btn.innerHTML = `<span class="text-base mb-1">${opt.display}</span><span class="scale-90 tracking-tighter">${opt.label}</span>`;
                btn.onclick = () => { selectedRating = opt.value; document.querySelectorAll('.rating-btn').forEach(b => { b.classList.replace('bg-yellow-400', 'bg-neutral-900'); b.classList.replace('text-black', 'text-neutral-400'); b.classList.replace('border-yellow-400', 'border-neutral-700'); }); btn.classList.replace('bg-neutral-900', 'bg-yellow-400'); btn.classList.replace('text-neutral-400', 'text-black'); btn.classList.replace('border-neutral-700', 'border-yellow-400'); };
                rg.appendChild(btn);
            });
        }

        function createBtn(txt, cls, onClick, active) {
            const b = document.createElement('button');
            b.className = `${cls} py-2 rounded-xl text-[10px] font-black border-2 transition-all ${active ? 'bg-yellow-400 text-black border-yellow-400' : 'bg-neutral-900 text-neutral-500 border-neutral-700'}`;
            b.innerText = txt; b.onclick = onClick; return b;
        }

        function refreshBtns(cls, val) {
            document.querySelectorAll('.'+cls).forEach(b => {
                const act = b.innerText === val;
                b.className = `${cls} py-2 rounded-xl text-[10px] font-black border-2 transition-all ${act ? 'bg-yellow-400 text-black border-yellow-400' : 'bg-neutral-900 text-neutral-500 border-neutral-700'}`;
            });
        }

        function updateStats() {
            const yearRecords = records.filter(r => r.date.startsWith('2026'));
            const monthPrefix = `2026-${String(currentMonth + 1).padStart(2, '0')}`;
            const monthRecords = records.filter(r => r.date.startsWith(monthPrefix));

            document.getElementById('stat-month-count').innerText = monthRecords.length;
            document.getElementById('stat-month-total').innerText = `$${monthRecords.reduce((s,r)=>s+Number(r.price),0)}`;
            document.getElementById('month-total-small').innerText = `$${monthRecords.reduce((s,r)=>s+Number(r.price),0)}`;
            document.getElementById('stat-year-count').innerText = yearRecords.length;
            document.getElementById('stat-year-total').innerText = `$${yearRecords.reduce((s,r)=>s+Number(r.price),0)}`;

            const shops = {}, items = {};
            yearRecords.forEach(r => { shops[r.shop] = (shops[r.shop]||0)+1; items[r.name] = (items[r.name]||0)+1; });
            document.getElementById('stat-top-shop').innerText = Object.entries(shops).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'å°šç„¡ç´€éŒ„';
            document.getElementById('stat-top-item').innerText = Object.entries(items).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'å°šç„¡ç´€éŒ„';
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = "";
            document.getElementById('calendar-title').innerText = `${currentMonth+1}æœˆ`;
            ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="text-center text-neutral-600 font-black text-[10px] pb-4 uppercase">${d}</div>`);
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const days = new Date(currentYear, currentMonth + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
            for(let day=1; day<=days; day++) {
                const ds = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dr = records.filter(r => r.date === ds);
                const isToday = new Date().toLocaleDateString('en-CA') === ds;
                let bg = "bg-neutral-800/40";
                if(dr.length === 1) bg = "bg-yellow-500 shadow-md"; else if(dr.length >= 2) bg = "bg-yellow-700 shadow-md";
                grid.innerHTML += `<div onclick="openModal('${ds}')" class="aspect-square rounded-2xl p-1.5 flex flex-col items-center justify-between cursor-pointer border-2 ${isToday?'border-white':'border-transparent'} ${bg} active:scale-95 transition-all"><span class="text-[9px] font-black ${dr.length>0?'text-black':'text-neutral-500'}">${day}</span><div class="flex flex-wrap justify-center gap-0.5">${dr.map(()=>`<span class="text-xs">ğŸ¥¤</span>`).join('')}</div></div>`;
            }
        }

        function changeMonth(dir) { currentMonth += dir; if(currentMonth>11){currentMonth=0;currentYear++;} if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); updateStats(); }

        function openModal(ds) { selectedDateStr = ds; document.getElementById('modal-date-badge').innerText = `${parseInt(ds.split('-')[1])}æœˆ ${parseInt(ds.split('-')[2])}æ—¥`; document.getElementById('modal').style.display = 'flex'; renderDailyList(); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function renderDailyList() {
            const container = document.getElementById('daily-list-container');
            const dayRecs = records.filter(r => r.date === selectedDateStr);
            container.innerHTML = dayRecs.length ? `<h3 class="text-[10px] text-neutral-500 font-black px-1 uppercase">ä»Šæ—¥ç´€éŒ„</h3>` : "";
            dayRecs.forEach(r => {
                container.innerHTML += `<div class="bg-neutral-800 border border-neutral-700 p-4 rounded-2xl flex justify-between items-center"><div><div class="flex items-center gap-2"><span class="bg-yellow-400 text-black text-[9px] px-2 py-0.5 rounded-full font-black uppercase">${r.type}</span><p class="font-black text-sm">${r.name}</p></div><p class="text-xs text-neutral-400 font-bold mt-1">${r.shop} Â· ${r.sugar}/${r.ice} Â· $${r.price}</p></div><button onclick="deleteRecord('${r.id}')" class="text-red-500 w-8 h-8 rounded-lg bg-red-500/10 active:bg-red-500 active:text-white transition-all"><i class="fas fa-trash-alt"></i></button></div>`;
            });
        }

        async function handleSave() {
            const name = document.getElementById('f-name').value, shop = document.getElementById('f-shop').value, price = document.getElementById('f-price').value;
            if(!name || !shop || !price) { showToast("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼"); return; }
            if(records.filter(r => r.date === selectedDateStr).length >= 2) { document.getElementById('warning-modal').style.display = 'flex'; return; }
            await confirmSave();
        }

        async function confirmSave() {
            const rec = { id: 'id-'+Date.now()+Math.random().toString(36).substr(2,4), date: selectedDateStr, name: document.getElementById('f-name').value, shop: document.getElementById('f-shop').value, price: document.getElementById('f-price').value, type: document.getElementById('f-type').value, sugar: selectedSugar, ice: selectedIce, rating: selectedRating, timestamp: Date.now() };
            await saveRecordToDB(rec);
            records = await getAllRecords();
            closeWarning(); renderDailyList(); renderCalendar(); updateStats(); showToast("è³‡æ–™å·²å¯«å…¥ç£ç¢Ÿ ğŸ’¾");
            document.getElementById('f-name').value = ""; document.getElementById('f-price').value = "";
        }

        async function deleteRecord(id) { await deleteRecordFromDB(id); records = await getAllRecords(); renderDailyList(); renderCalendar(); updateStats(); showToast("å·²å¾ç£ç¢Ÿç§»é™¤"); }
        function closeWarning() { document.getElementById('warning-modal').style.display = 'none'; }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2500); }
    </script>
</body>
</html>